<!-- This *ngIf ensures the component is only in the DOM when it's supposed to be visible -->
<ng-container *ngIf="isOpen">
  <!-- Overlay to dim the background -->
  <div class="sidebar-overlay active" (click)="close()"></div>

  <!-- The main sidebar container -->
  <div class="sidebar-wrapper active">
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <h4 class="fw-bold mb-0">Order History</h4>
      <button type="button" class="btn-close" aria-label="Close" (click)="close()"></button>
    </div>

    <!-- Sidebar Body with scroll -->
    <div class="sidebar-body">
      <section class="order-history-view" *ngIf="item">
        <!-- Centered Order Info Header -->
        <div class="text-center order-info-header">
          <h5 class="mb-1">Order #{{ item?.order_number }}</h5>
          <!-- Removed "text-muted" class to make the date darker -->
          <p class="mb-0">
            Created: {{ item?.created_at | date:'medium' }}
          </p>
        </div>

        <!-- Timeline -->
        <div class="timeline-container">
          <!-- Loop through each processed event -->
          <div class="timeline-item" *ngFor="let event of displayedEvents">
            <div class="timeline-icon" [ngClass]="'icon-' + event.event_type" [attr.title]="event.event_type">
              <i class="ti" [ngClass]="{
                'ti-circle-plus': event.event_type === 'order_created',
                'ti-arrows-exchange': event.event_type === 'status_change',
                'ti-credit-card-pay': event.event_type === 'payment_status',
                'ti-trash': event.event_type === 'order_deleted',
                'ti-shopping-cart': event.event_type === 'product_added',
                'ti-pencil': event.event_type === 'product_updated',
                'ti-layout-grid2': event.event_type === 'order_type',
                'ti-wallet': event.event_type === 'payment_method'
              }"></i>
            </div>

            <div class="timeline-content">
              <div class="d-flex justify-content-between align-items-center flex-wrap">
                <h5 class="fw-bold mb-1 me-2">
                  <ng-container [ngSwitch]="event.event_type">
                    <span *ngSwitchCase="'order_created'">Order Placed</span>
                    <span *ngSwitchCase="'status_change'">Status Changed</span>
                    <span *ngSwitchCase="'payment_status'">Payment Status Updated</span>
                    <span *ngSwitchCase="'order_deleted'">Order Deleted</span>
                    <span *ngSwitchCase="'order_type'">Order Type Changed</span>
                    <span *ngSwitchCase="'payment_method'">Payment Method Changed</span>
                    <span *ngSwitchDefault>{{ event.event_type | titlecase }}</span>
                  </ng-container>
                </h5>
                <small class="text-muted">{{ event.timestamp | date:'medium' }}</small>
              </div>

              <!-- Non-product events (keeps existing wording) -->
              <p class="mb-1 mt-1" *ngIf="!event.event_type.startsWith('product')">
                <ng-container [ngSwitch]="event.event_type">
                  <span *ngSwitchCase="'order_created'">
                    Order was placed with status: <strong class="text-primary">{{ event.new_value | titlecase }}</strong>
                  </span>
                  <span *ngSwitchCase="'status_change'">
                    Status changed from <strong class="text-danger">{{ event.old_value | titlecase }}</strong> to <strong class="text-success">{{ event.new_value | titlecase }}</strong>.
                  </span>
                  <span *ngSwitchCase="'payment_status'">
                    Payment changed from <strong class="text-danger">{{ event.old_value }}</strong> to <strong class="text-success">{{ event.new_value }}</strong>.
                  </span>
                  <span *ngSwitchCase="'order_type'">
                    Order type changed from <strong>{{ event.old_value }}</strong> to <strong>{{ event.new_value }}</strong>.
                  </span>
                  <span *ngSwitchCase="'payment_method'">
                    Payment method changed from <strong>{{ event.old_value }}</strong> to <strong>{{ event.new_value }}</strong>.
                  </span>
                </ng-container>
              </p>

              <!-- Product events: summary + collapsible details -->
              <div *ngIf="event.event_type.startsWith('product')">
                <p class="mb-1">
                  <ng-container *ngIf="event.event_type === 'product_added'">
                    New product added: <strong>{{ event.newValueParsed?.name || event.newValueParsed?.product_id }}</strong>
                    (Qty: {{ event.newValueParsed?.quantity }}, Price: {{ event.newValueParsed?.price }})
                  </ng-container>

                  <ng-container *ngIf="event.event_type === 'product_removed'">
                    Product updated: <strong>{{ event.newValueParsed?.name || event.newValueParsed?.product_id }}</strong>
                    (Qty: {{ event.newValueParsed?.quantity }}, Price: {{ event.newValueParsed?.price }})
                  </ng-container>

                  <button type="button" class="btn btn-link btn-sm" (click)="toggleDetails(event)">
                    {{ event._open ? 'Hide details' : 'Show details' }}
                  </button>
                </p>

                <div class="card card-body mt-2" *ngIf="event._open">
                  <!-- PRODUCT ADDED -->
                  <ng-container *ngIf="event.event_type === 'product_added'">
                    <div class="product-detail">
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                          <h6 class="mb-1 product-title">{{ event.newValueParsed?.name || ('#' + (event.newValueParsed?.product_id)) }}</h6>
                          <div class="small text-muted">Qty: <strong>{{ event.newValueParsed?.quantity }}</strong> 路 Price: <strong>{{ event.newValueParsed?.price }}</strong></div>
                          <div *ngIf="event.newValueParsed?.notes" class="mt-2 note">
                            <span class="badge bg-info me-2">Notes</span>{{ event.newValueParsed?.notes }}
                          </div>
                        </div>
                        <div class="text-end">
                          <span class="badge bg-success">Added</span>
                        </div>
                      </div>

                      <div *ngIf="event.newValueParsed?.variation?.length" class="mt-2">
                        <p class="mb-2 fw-semibold variation-heading">Variation</p>
                        <div class="variation-list">
                          <div *ngFor="let v of event.newValueParsed?.variation" class="variation-item">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                              <div class="variation-type">{{ v.type || 'Option' }}</div>
                              <div *ngIf="v.selected" class="badge bg-primary">Selected</div>
                            </div>
                            <div *ngIf="v.options?.length" class="options">
                              <div *ngFor="let opt of v.options" class="option-row">
                                <div class="opt-info">
                                  <div class="opt-name">{{ opt.name }}</div>
                                  <div class="opt-desc small text-muted">{{ opt.description }}</div>
                                </div>
                                <div class="opt-price small text-muted">{{ opt.price ? (opt.price | currency) : '' }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-container>

                  <!-- PRODUCT REMOVED -->
                  <ng-container *ngIf="event.event_type === 'product_removed'">
                    <div class="product-detail">
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                          <h6 class="mb-1 text-danger product-title">{{ event.oldValueParsed?.name || ('#' + (event.oldValueParsed?.product_id)) }}</h6>
                          <div class="small text-muted">Qty: <strong>{{ event.oldValueParsed?.quantity }}</strong> 路 Price: <strong>{{ event.oldValueParsed?.price }}</strong></div>
                        </div>
                        <div class="text-end">
                          <span class="badge bg-danger">Removed</span>
                        </div>
                      </div>

                      <div *ngIf="event.oldValueParsed?.variation?.length" class="mt-2">
                        <p class="mb-2 fw-semibold variation-heading">Variation</p>
                        <div class="variation-list">
                          <div *ngFor="let v of event.oldValueParsed?.variation" class="variation-item">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                              <div class="variation-type">{{ v.type || 'Option' }}</div>
                              <div *ngIf="v.selected" class="badge bg-primary">Selected</div>
                            </div>
                            <div *ngIf="v.options?.length" class="options">
                              <div *ngFor="let opt of v.options" class="option-row">
                                <div class="opt-info">
                                  <div class="opt-name">{{ opt.name }}</div>
                                  <div class="opt-desc small text-muted">{{ opt.description }}</div>
                                </div>
                                <div class="opt-price small text-muted">{{ opt.price ? (opt.price | currency) : '' }}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-container>

                  <!-- PRODUCT UPDATED -->
                  <ng-container *ngIf="event.event_type === 'product_updated'">
                    <div class="row">
                      <div class="col-12 col-md-6">
                        <div class="product-detail old-detail">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                              <h6 class="mb-1 product-title">{{ event.oldValueParsed?.name || ('#' + (event.oldValueParsed?.product_id)) }}</h6>
                              <div class="small text-muted">Qty: <strong>{{ event.oldValueParsed?.quantity }}</strong> 路 Price: <strong>{{ event.oldValueParsed?.price }}</strong></div>
                            </div>
                            <div class="text-end">
                              <span class="badge bg-warning text-dark">Old</span>
                            </div>
                          </div>

                          <div *ngIf="event.oldValueParsed?.variation?.length" class="mt-2">
                            <p class="mb-2 fw-semibold variation-heading">Variation</p>
                            <div class="variation-list">
                              <div *ngFor="let v of event.oldValueParsed?.variation" class="variation-item">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                  <div class="variation-type">{{ v.type || 'Option' }}</div>
                                  <div *ngIf="v.selected" class="badge bg-primary">Selected</div>
                                </div>
                                <div *ngIf="v.options?.length" class="options">
                                  <div *ngFor="let opt of v.options" class="option-row">
                                    <div class="opt-info">
                                      <div class="opt-name">{{ opt.name }}</div>
                                      <div class="opt-desc small text-muted">{{ opt.description }}</div>
                                    </div>
                                    <div class="opt-price small text-muted">{{ opt.price ? (opt.price | currency) : '' }}</div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-12 col-md-6">
                        <div class="product-detail new-detail">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                              <h6 class="mb-1 product-title">{{ event.newValueParsed?.name || ('#' + (event.newValueParsed?.product_id)) }}</h6>
                              <div class="small text-muted">Qty: <strong>{{ event.newValueParsed?.quantity }}</strong> 路 Price: <strong>{{ event.newValueParsed?.price }}</strong></div>
                            </div>
                            <div class="text-end">
                              <span class="badge bg-success">New</span>
                            </div>
                          </div>

                          <div *ngIf="event.newValueParsed?.variation?.length" class="mt-2">
                            <p class="mb-2 fw-semibold variation-heading">Variation</p>
                            <div class="variation-list">
                              <div *ngFor="let v of event.newValueParsed?.variation" class="variation-item">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                  <div class="variation-type">{{ v.type || 'Option' }}</div>
                                  <div *ngIf="v.selected" class="badge bg-primary">Selected</div>
                                </div>
                                <div *ngIf="v.options?.length" class="options">
                                  <div *ngFor="let opt of v.options" class="option-row">
                                    <div class="opt-info">
                                      <div class="opt-name">{{ opt.name }}</div>
                                      <div class="opt-desc small text-muted">{{ opt.description }}</div>
                                    </div>
                                    <div class="opt-price small text-muted">{{ opt.price ? (opt.price | currency) : '' }}</div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>

              <p class="text-muted performed-by mt-2">Performed by: <strong>{{ event.performed_by }}</strong></p>
            </div>
          </div>

          <!-- Fallback if no events exist -->
          <div *ngIf="!displayedEvents?.length" class="text-center py-5">
            <i class="ti ti-history-toggle" style="font-size: 3rem; color: #ccc;"></i>
            <h5 class="mt-3">No History Found</h5>
            <p class="text-muted">There are no events recorded for this order yet.</p>
          </div>
        </div>
      </section>
    </div>
  </div>
</ng-container>
