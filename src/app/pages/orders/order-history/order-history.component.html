
<!-- This *ngIf ensures the component is only in the DOM when it's supposed to be visible -->
<ng-container *ngIf="isOpen">
  <!-- Overlay to dim the background -->
  <div class="sidebar-overlay active" (click)="close()"></div>

  <!-- The main sidebar container -->
  <div class="sidebar-wrapper active">
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <h4 class="fw-bold mb-0">Order History</h4>
      <button type="button" class="btn-close" aria-label="Close" (click)="close()"></button>
    </div>

    <!-- Sidebar Body with scroll -->
    <div class="sidebar-body">
      <section class="order-history-view" *ngIf="item">
        <!-- Centered Order Info Header -->
        <div class="text-center order-info-header">
          <h5 class="mb-1">Order #{{ item?.order_number }}</h5>
          <!-- Removed "text-muted" class to make the date darker -->
          <p class="mb-0">
            Created: {{ item?.created_at | date:'medium' }}
          </p>
        </div>

        <!-- Timeline -->
        <div class="timeline-container">
          <!-- Loop through each processed event -->
          <div class="timeline-item" *ngFor="let event of processedEvents">
            <div class="timeline-icon" [ngClass]="'icon-' + event.event_type">
              <i class="ti" [ngClass]="{
                'ti-circle-plus': event.event_type === 'order_created',
                'ti-arrows-exchange': event.event_type === 'status_change',
                'ti-credit-card-pay': event.event_type === 'payment_status',
                'ti-trash': event.event_type === 'order_deleted'
              }"></i>
            </div>
            <div class="timeline-content">
              <div class="d-flex justify-content-between align-items-center flex-wrap">
                <h5 class="fw-bold mb-1 me-2">
                  <ng-container [ngSwitch]="event.event_type">
                    <span *ngSwitchCase="'order_created'">Order Placed</span>
                    <span *ngSwitchCase="'status_change'">Status Changed</span>
                    <span *ngSwitchCase="'payment_status'">Payment Status Updated</span>
                    <span *ngSwitchCase="'order_deleted'">Order Deleted</span>
                    <span *ngSwitchDefault>{{ event.event_type | titlecase }}</span>
                  </ng-container>
                </h5>
                <small class="text-muted">{{ event.timestamp | date:'medium' }}</small>
              </div>
              <p class="mb-1 mt-1">
                <ng-container [ngSwitch]="event.event_type">
                  <span *ngSwitchCase="'order_created'">
                    Order was placed with status: <strong class="text-primary">{{ event.new_value | titlecase }}</strong>
                  </span>
                  <span *ngSwitchCase="'status_change'">
                    Status changed from <strong class="text-danger">{{ event.old_value | titlecase }}</strong> to <strong class="text-success">{{ event.new_value | titlecase }}</strong>.
                  </span>
                   <span *ngSwitchCase="'payment_status'">
                    Payment changed from <strong class="text-danger">{{ event.old_value }}</strong> to <strong class="text-success">{{ event.new_value }}</strong>.
                  </span>
                  <span *ngSwitchCase="'order_deleted'">
                    The order was moved to the trash.
                  </span>
                </ng-container>
              </p>
              <p class="text-muted performed-by mt-2">Performed by: <strong>{{ event.performed_by }}</strong></p>
            </div>
          </div>
          <!-- Fallback if no events exist -->
          <div *ngIf="!processedEvents?.length" class="text-center py-5">
              <i class="ti ti-history-toggle" style="font-size: 3rem; color: #ccc;"></i>
              <h5 class="mt-3">No History Found</h5>
              <p class="text-muted">There are no events recorded for this order yet.</p>
          </div>
        </div>
      </section>
    </div>
  </div>
</ng-container>
